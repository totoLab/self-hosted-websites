---

let projects = [];
let recentActivities = [];
const proxyUrl = "https://api.antolab.xyz/github-totolab"

try {
  // Fetch a limited number of projects at build time or during server rendering
  const projectsResponse = await fetch(`${proxyUrl}/repos`);

  if (projectsResponse.ok) {
    const allProjects = await projectsResponse.json();

    // Order projects by stargazers_count and forks_count, then slice to get top 9
    projects = allProjects
      .sort((a, b) => {
        if (b.stargazers_count !== a.stargazers_count) {
          return b.stargazers_count - a.stargazers_count;
        }
        return b.forks_count - a.forks_count;
      })
      .slice(0, 9);
  } else if (projectsResponse.status === 403) {
    console.error('GitHub API rate limit exceeded while fetching projects.');
  } else {
    console.error('Failed to fetch projects:', projectsResponse.status);
  }

  // Fetch recent GitHub activities
  const activitiesResponse = await fetch(`${proxyUrl}/events/public`);

  if (activitiesResponse.ok) {
    const activities = await activitiesResponse.json();

    if (Array.isArray(activities)) {
      recentActivities = activities.slice(0, 10);
    } else {
      console.error('Unexpected format for activities data:', activities);
    }
  } else if (activitiesResponse.status === 403) {
    console.error('GitHub API rate limit exceeded while fetching activities.');
  } else {
    console.error('Failed to fetch activities:', activitiesResponse.status);
  }
} catch (error) {
  console.error('An error occurred while fetching data:', error);
}
---

<div class="github-activity">
  <h3>Recent GitHub Activity</h3>
  <ul>
    {recentActivities.length > 0 ? (
      recentActivities.map(activity => (
        <li key={activity.id}>
          {activity.type === 'PushEvent' && 
            `Pushed to ${activity.repo.name}`}
          {activity.type === 'CreateEvent' && 
            `Created ${activity.payload.ref_type} in ${activity.repo.name}`}
        </li>
      ))
    ) : (
      <p>No recent activity found or an error occurred.</p>
    )}
  </ul>
</div>

<style>
  .github-activity {
    padding: 1.25rem;
  }

  .github-activity h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
  }

  .github-activity ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .github-activity li {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-size: 0.875rem;
    transition: var(--transition-default);
  }

  .github-activity li:last-child {
    border-bottom: none;
  }

  .github-activity li:hover {
    background-color: var(--background-light);
  }
</style>
